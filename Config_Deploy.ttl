; Tera Term Macro (TTL) for Line-by-Line Configuration Deployment
; This macro ensures configuration is sent reliably by pausing between each line.
; You must be in configure terminal mode.

; 1. User input
host_name = 'host_name' ; hostname of the equipment (used for log file name)
Config_file = 'file_name.txt' ; configuration file name for the equipment

; 2. Establish connection (if failed, end and close program)
for COM_PORT_int 1 10 ; Try connecting Tera Term and check if your COM port number is in the range
  int2str COM_PORT_str COM_PORT_int
  login_command = '/C='
  strconcat login_command COM_PORT_str
  strconcat login_command ' /BAUD=9600'
  connect login_command
  if result=2 then
    break
  endif
next

if result=2 then
else
  closett
  end
endif

; Create folder to save log and invalid command
getdir C_dir
getdate Log_date '_%Y%m%d-%H%M%S'
Log_folder = C_dir
strconcat Log_folder '\'
strconcat Log_folder Log_date
foldercreate Log_folder

; Invalid command file name setting
Invalid_command_file = Invalid_folder
strconcat Invalid_command_file '\'
getdate Invalid_date '_%Y%m%d-%H%M%S'
strconcat Invalid_command_file host_name
strconcat Invalid_command_file Log_date
strconcat Invalid_command_file '.txt

; Log file name setting
Log_file = Log_folder
strconcat Log_file '\'
getdate Log_date '_%Y%m%d-%H%M%S'
strconcat Log_file host_name
strconcat Log_file Log_date
strconcat Log_file '.log'

; 3. Main Configuration Loop (The core logic)
:deploy
  ; Read one line from the file
  filereadln filehandle line
  result = result
  
  ; Check for End of File (EOF)
  if result < 0 goto deployment_complete

  ; Check if the line is not empty (e.g., skips blank lines)
  if strlen(line) > 0 then
    ; Send the line and press Enter
    sendln line
    
    ; *** CRITICAL DELAY ***
    ; Pause for 100 milliseconds to prevent device buffer overflow
    pause 100
  endif

  ; Check if the command was successfully deployed (if not, save the command to Invalid_command_file)
  wait '#' '%'
  ; '#' = successfully deployed -> go to deploy
ã€€if result = 1 goto deploy
  ; '%' = common symbol for 'valid command' -> log the command
  if result = 2 goto invalid

 
:valid
 


; 6. Cleanup and Save
:deployment_complete
  ; Exit Configuration Mode
  sendln 'end'
  wait '#'
  
  ; Save the configuration (Use 'write memory' for older Cisco devices, 'copy run start' for newer)
  sendln 'write memory'
  wait '#'

  ; Close the file handle
  fileclose filehandle


:end_macro
  ; End of macro
  end
