; Tera Term Macro (TTL) for Line-by-Line Configuration Deployment
; This macro ensures configuration is sent reliably by pausing between each line.
; You must be in configure terminal mode.

; <<<< EDIT HERE  >>>>
host_name = 'host_name' ; hostname of the equipment (used for log file name)
Config_file = 'file_name.txt' ; configuration file name for the equipment



; 2. Establish connection (if failed, end and close program)
for COM_PORT_int 1 10 ; Try connecting Tera Term and check if your COM port number is in the range
  if result=2 then
    break
  endif
next

if result=2 then
else
  closett
  end
endif

; Create folder to save log and invalid command
getdir C_dir
getdate Log_date '_%Y%m%d-%H%M%S'
Log_folder = C_dir
strconcat Log_folder '\'
strconcat Log_folder Log_date
foldercreate Log_folder

; Invalid command file name setting
Invalid_command_file = Invalid_folder
strconcat Invalid_command_file '\'
getdate Invalid_date '_%Y%m%d-%H%M%S'
strconcat Invalid_command_file host_name
strconcat Invalid_command_file Log_date
strconcat Invalid_command_file '.txt

; Log file name setting
Log_file = Log_folder
strconcat Log_file '\'
getdate Log_date '_%Y%m%d-%H%M%S'
strconcat Log_file host_name
strconcat Log_file Log_date
strconcat Log_file '.log'



; Main logic
:deploy
 ; Read config source file
 filereadln config_filehandle line

 ; If result was smaller than 0, end macro
 if result < 0 goto end

 ; If it's not the end of the config file
 if strlen(line) > 0 then
  sendln line
  pause 100

  wait '#' '>' '%'
  if result = 1 
   goto deploy
  endif

  if result = 2 
   sendln 'enable'
   wait '#'
   sendln 'conf t'
   wait '#' then goto deploy
  endif

  if result = 3 
   filewriteln invalid_filehandle line
   wait '#'
   goto deploy
  endif

 endif

 
; 6. Cleanup and Save
:deployment_complete
  ; Exit Configuration Mode
  sendln 'end'
  wait '#'
  
  ; Save the configuration (Use 'write memory' for older Cisco devices, 'copy run start' for newer)
  sendln 'write memory'
  wait '#'

  ; Close the file handle
  fileclose filehandle


:end_macro
  ; End of macro
  end
