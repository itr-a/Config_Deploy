; Tera Term Macro (TTL) for Line-by-Line Configuration Deployment
; This macro ensures configuration is sent reliably by pausing between each line.
; You must be in configure terminal mode.

; <<<< EDIT HERE  >>>>
host_name = 'host_name' ; hostname of the equipment (used for log file name)
config_file = 'file_name.txt' ; configuration file name for the equipment

password = 'cisco'
enable_pass = 'cisco'

config_filehandle = 0
invalid_filehandle = 0

; 2. Establish connection (if failed, end and close program)
for COM_PORT_int 1 10 ; Try connecting Tera Term and check if your COM port number is in the range
  int2str COM_PORT_str COM_PORT_int
  login_command = '/C='
  strconcat login_command COM_PORT_str
  strconcat login_command ' /BAUD=9600'
  connect login_command
  if result=2 then
    break
  endif
next

; Create folder to save files
getdir C_dir
getdate Log_date '_%Y%m%d'

Log_folder = C_dir
strconcat Log_folder '\'
strconcat Log_folder Log_date
foldercreate Log_folder

getdate Log_date '_%Y%m%d_%H%M%S'

; Log file name setting
Log_file = Log_folder
strconcat Log_file '\'
getdate Log_date '_%Y%m%d-%H%M%S'
strconcat Log_file host_name
strconcat Log_file Log_date
strconcat Log_file '.log'

; Invalid command file name setting
invalid_folder = Log_folder
strconcat invalid_file '\'
getdate invalid_date '_%Y%m%d-%H%M%S'
strconcat invalid_file Log_date
strconcat invalid_file '_invalid.txt'

fileopen config_filehandle config_file 0 0
if config_filehandle < 0 then
 sendln 'macro closed due to config file unopenable'
 goto end_macro
endif

fileopen invalid_filehandle invalid_command 1
if invalid_filehandle < 0 then
 goto end_macro
endif


; log in
wait 'Password:'
sendln password
wait '>'

; start logging
logopen

sendln 'enable'
wait 'password:'
sendln enable_pass
wait '#'
sendln 'conf t'
wait #
goto deploy


; Main logic
:deploy
 ; Read config source file
 filereadln config_filehandle line

 ; If result was smaller than 0, end macro
 if result < 0 goto end

 ; If it's not the end of the config file
 if strlen(line) > 0 then
  sendln line
  pause 100

  wait '#' '%'
  if result = 1 
   goto deploy
  endif

  if result = 2 
   filewriteln invalid_filehandle line
   wait '#'
   goto deploy
  endif

 endif
 goto deploy

 
; Cleanup and Save
:end
  ; Exit Configuration Mode
  sendln 'end'
  wait '#'
  
  ; Save the configuration
  sendln 'write memory'
  wait '#'

  ; Close the file handle
  fileclose config_filehandle
  fileclose invalid_filehandle


:end_macro
  ; End of macro
  end
